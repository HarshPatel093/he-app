
{% extends "base.html" %}
{% block title %}Admin Dashboard{% endblock %}

{% block content %}
<!-- Month Filter + Reset Button -->
<div class="page-actions">
  <form id ="month-form" method ="get" action="{% url 'admin_dashboard' %}">
  <select name="month" id="month-select" class="btn1">
    {% for value, label in month_options %}
    <option value="{{ value }}" {% if value == month_value %} selected{% endif %}>
      {{ label }}
    </option>
    {% endfor %}
  </select>
</form>
<a class="btn2" href="{% url 'admin_dashboard' %}">Reset</a>
</div>
<!-- Chart Grid Layout (4 Charts) -->
<div style="
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  grid-template-rows: repeat(2, 1fr);
  row-gap: 60px;
  column-gap: 40px; 
  width: 100%;
  min-height: 100vh;
  padding: 20px;
  box-sizing: border-box;
  justify-items: center;
  align-items: start;
">

 <!-- Goals Added (Weekly) -->
  <div style="width: 350px; height: 350px;">
    <canvas id="monthlyGoalsPie"></canvas>
  </div>
  
  <!-- Client Feedback Distribution -->
  <div style="width: 350px; height: 350px;">
    <canvas id="weeklyFeedbackPie"></canvas>
  </div>

  <!-- Goals by Type -->
  <div style="width: 350px; height: 350px;">
    <canvas id="goalsByTypePie"></canvas>
  </div>

  <!-- Staff Engagement (Bar Chart) -->
  <div style="width: 350px; height: 350px;">
      <canvas id="staffEngagementBar"></canvas>
  </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>

<script>
  document.getElementById('month-select').addEventListener('change' , function() {
    document.getElementById('month-form').submit();
  })

   /* Chart 1: Monthly Goals (Pie Chart) */
const goalData = {{ goal_data|safe }};
const ctx = document.getElementById('monthlyGoalsPie');

new Chart(ctx, {
    type: 'pie',
    data: {
        labels: goalData.every(v => v === 0) ? ['No Data'] : {{ goal_labels|safe }},
        datasets: [{
            label: 'Goals Added',
            data: goalData.every(v => v === 0) ? [1] : goalData,
            backgroundColor: goalData.every(v => v === 0)
                ? ['#e5e7eb']  // neutral gray for no data
                : ['#60a5fa', '#34d399', '#fbbf24', '#f87171'],
            hoverOffset: 10
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            title: {
                display: true,
                text: 'Goals Added in {{ month_name }}',
                font: { size: 16 }
            },
            legend: {
                position: 'bottom',
                labels: { boxWidth: 12, font: { size: 12 } }
            },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        if (goalData.every(v => v === 0)) {
                            return 'No data available';
                        }
                        const label = context.label || '';
                        const value = context.raw;
                        const total = context.chart._metasets[0].total;
                        const percentage = ((value / total) * 100).toFixed(1);
                        return `${label}: ${value} goals (${percentage}%)`;
                    }
                }
            },
            datalabels: { 
                color: '#fff',
                font: { weight: 'bold', size: 12 },
                formatter: function(value, ctx) {
                  const total = ctx.chart._metasets[0].total;
                  if (!total || value === 0) return '';  
                  const percentage = (value / total) * 100;
                  return percentage < 1 ? '' : percentage.toFixed(1) + '%';
              }

            }
        }
    },
    plugins: [ChartDataLabels]
});

   /* Chart 2: Weekly Feedback (Pie Chart) */

const feedbackData = {{ feedback_data|safe }};
const feedbackCtx = document.getElementById('weeklyFeedbackPie');
new Chart(feedbackCtx, {
    type: 'pie',
    data: {
        labels: feedbackData.every(v => v === 0) ? ['No Data'] : {{ feedback_labels|safe }},
        datasets: [{
            label: 'Client Feedback',
            data: feedbackData.every(v => v === 0) ? [1] : feedbackData,
            backgroundColor: feedbackData.every(v => v === 0)
                ? ['#e5e7eb']
                : ['#ef4444', '#f97316', '#facc15', '#34d399', '#22c55e'],
            hoverOffset: 10
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            title: {
                display: true,
                text: 'Client Feedbacks ({{ month_name }})',
                font: { size: 16 }
            },
            legend: {
                position: 'bottom',
                labels: { boxWidth: 12, font: { size: 12 } }
            },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        if (feedbackData.every(v => v === 0)) {
                            return 'No data available';
                        }
                        const label = context.label || '';
                        const value = context.raw;
                        const total = context.chart._metasets[0].total;
                        const percentage = ((value / total) * 100).toFixed(1);
                        return `${label}: ${value} feedbacks (${percentage}%)`;
                    }
                }
            },
            datalabels: {
              color: '#fff',
              font: { weight: 'bold', size: 12 },
              formatter: function(value, ctx) {
                const total = ctx.chart._metasets[0].total;
                if (!total || value === 0) return '';
                const percentage = (value / total) * 100;
                return percentage < 1 ? '' : percentage.toFixed(1) + '%';
              }
            }
          }
    },
    plugins: [ChartDataLabels]
});

   /* Chart 3: Goals by Type (Doughnut Pie)) */

const typeData = {{ goal_type_data|safe }};
const typeCtx = document.getElementById('goalsByTypePie');
new Chart(typeCtx, {
  type: 'doughnut',
  data: {
    labels: typeData.length ? {{ goal_type_labels|safe }} : ['No Data'],
    datasets: [{
      label: 'Goals Added by Type',
      data: typeData.length ? typeData : [1],
      backgroundColor: typeData.length
        ? ['#60a5fa', '#34d399', '#fbbf24', '#f87171', '#a78bfa', '#4ade80']
        : ['#e5e7eb'],
      borderWidth: 2,             
      hoverOffset: 10
    }]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    cutout: '37%',                
    layout: { padding: {
      top: -10,        
      bottom: -10
    } },      
    plugins: {
      title: {
        display: true,
        text: 'Goals by Type ({{ month_name }})',
        font: { size: 16 }
      },
      legend: {
        position: 'bottom',
        labels: { boxWidth: 12, font: { size: 12 } }
      },
      tooltip: {
        callbacks: {
          label: function(context) {
            if (typeData.length === 0) return 'No data available';
            const label = context.label || '';
            const value = context.raw;
            const total = context.chart._metasets[0].total;
            const percentage = ((value / total) * 100).toFixed(1);
            return `${label}: ${value} goals (${percentage}%)`;
          }
        }
      },
      datalabels: {
        color: '#fff',
        font: { weight: 'bold', size: 12 },
        formatter: function(value, ctx) {
          const total = ctx.chart._metasets[0].total;
          if (!total || value === 0) return '';
          const percentage = (value / total) * 100;
          return percentage < 1 ? '' : percentage.toFixed(1) + '%';
        }
      }
    }
  },
  plugins: [ChartDataLabels]
});

   /* Chart 4: Staff Engagement (Bar Chart) */

const staffData = {{ staff_data|safe }};
const staffCtx = document.getElementById('staffEngagementBar');
new Chart(staffCtx, {
  type: 'bar',
  data: {
    labels: staffData.every(v => v === 0) ? ['No Data'] : {{ staff_labels|safe }},
    datasets: [{
      label: 'Staff Responses',
      data: staffData.every(v => v === 0) ? [0] : staffData,
      backgroundColor: staffData.every(v => v === 0)
        ? ['#e5e7eb']
        : ['#60a5fa', '#34d399', '#fbbf24', '#f87171'],
      borderWidth: 1
    }]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    scales: {
      y: {
        beginAtZero: true,
        ticks: {
          stepSize: 1
        },
        title: {
          display: true,
          text: 'Notes submitted by staff',
          font: { size: 14, weight: 'bold' },
          color: '#333'
        },
        grid: {
          color: '#f3f4f6'
        }
      },
      x: {
        title: {
          display: true,
          text: 'Weeks',
          font: { size: 14, weight: 'bold' },
          color: '#333'
        },
        grid: {
          color: '#f9fafb'
        }
      }
    },
    plugins: {
      title: {
        display: true,
        text: 'Weekly Staff Engagement ({{ month_name }})',
        font: { size: 16 }
      },
      legend: { display: false },
      tooltip: {
        callbacks: {
          label: function(context) {
            if (staffData.every(v => v === 0)) return 'No data available';
            return `${context.label}: ${context.raw} responses`;
          }
        }
      }
      ,
      datalabels: {
        color: function(context) {
          const bg = context.dataset.backgroundColor[context.dataIndex];
          if (!bg) return '#fff';
          const rgb = bg.replace(/[^\d,]/g, '').split(',');
          const brightness = (0.299 * rgb[0]) + (0.587 * rgb[1]) + (0.114 * rgb[2]);
          return brightness > 160 ? '#111' : '#fff'; // auto white/black for contrast
        },
        anchor: 'center',      // stays inside the bar
        align: 'center',       // vertically centered in the bar
        font: { weight: 'bold', size: 13 },
        clip: false,
        formatter: function(value) {
          if (value === 0) return ''; // hide empty bars
          return value.toString() + "%";
        }
      }
    }
  },
  plugins: [ChartDataLabels]
});
</script>
<style>

    .page-actions{
        display:flex;
        justify-content: flex-end;
        align-items: center;
        gap:15px;
        margin: 2px 10px 20px 0;
    }

    .btn1, .btn2 {    
        display: inline-block;
        padding: 10px 40px;
        background: #fff;
        color: #111;
        border-radius: 10px;
        text-decoration: none;
        font-weight: 500;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        transition: transform 0.15s ease, box-shadow 0.15s ease;
        border: none;
        cursor: pointer;
        font-size: 14px;
        height: 42px;
        line-height: 22px;
        box-sizing: border-box;
    }

    .btn1:hover, .btn2:hover {
        transform: translateY(-1px);
        box-shadow: 0 6px 18px rgba(0,0,0,0.12);
    }

    select.btn1{
        cursor: pointer;
        border: none;
        outline: none;
        appearance: none;
        text-align: center;
        text-align-last: center;
        padding: 10px 40px;
        font-size: 14px;
    }
</style>

{% endblock %}