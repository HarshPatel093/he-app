
{% extends "base.html" %}
{% block title %}Admin Dashboard{% endblock %}

{% block content %}
<div class="page-actions">
  <form id ="month-form" method ="get" action="{% url 'admin_dashboard' %}"
  <select name="month" id="month_select" class="btn1">
    {% for value, label in month_options %}
    <option value="{{ "value" }}" {% if value == month_value %} selected{%endif%%}>
      {{ label }}
    </option>
    {% endfor %}
    <a class="btn2" href="{% url 'admin_dashboard' %}">Reset</a>
</div>
<div style="
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  grid-template-rows: repeat(2, 1fr);
  row-gap: 60px;
  column-gap: 40px; 
  width: 100%;
  min-height: 100vh;
  padding: 20px;
  box-sizing: border-box;
  justify-items: center;
  align-items: start;
">

  <div style="width: 350px; height: 350px;">
    <canvas id="monthlyGoalsPie"></canvas>
  </div>
  
  <div style="width: 350px; height: 350px;">
    <canvas id="weeklyFeedbackPie"></canvas>
  </div>

  <div style="width: 350px; height: 350px;">
    <canvas id="goalsByTypePie"></canvas>
  </div>

  <div style="width: 350px; height: 350px;">
      <canvas id="staffEngagementBar"></canvas>
  </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
const goalData = {{ goal_data|safe }};
const ctx = document.getElementById('monthlyGoalsPie');

new Chart(ctx, {
    type: 'pie',
    data: {
        labels: goalData.every(v => v === 0) ? ['No Data'] : {{ goal_labels|safe }},
        datasets: [{
            label: 'Goals Added',
            data: goalData.every(v => v === 0) ? [1] : goalData,
            backgroundColor: goalData.every(v => v === 0)
                ? ['#e5e7eb']  // neutral gray for no data
                : ['#60a5fa', '#34d399', '#fbbf24', '#f87171'],
            hoverOffset: 10
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            title: {
                display: true,
                text: 'Goals Added in {{ month_name }}',
                font: { size: 16 }
            },
            legend: {
                position: 'bottom',
                labels: { boxWidth: 12, font: { size: 12 } }
            },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        if (goalData.every(v => v === 0)) {
                            return 'No data available';
                        }
                        const label = context.label || '';
                        const value = context.raw;
                        const total = context.chart._metasets[0].total;
                        const percentage = ((value / total) * 100).toFixed(1);
                        return `${label}: ${value} goals (${percentage}%)`;
                    }
                }
            }
        }
    }
});

const feedbackData = {{ feedback_data|safe }};
const feedbackCtx = document.getElementById('weeklyFeedbackPie');
new Chart(feedbackCtx, {
    type: 'pie',
    data: {
        labels: feedbackData.every(v => v === 0) ? ['No Data'] : {{ feedback_labels|safe }},
        datasets: [{
            label: 'Client Feedback',
            data: feedbackData.every(v => v === 0) ? [1] : feedbackData,
            backgroundColor: feedbackData.every(v => v === 0)
                ? ['#e5e7eb']
                : ['#a78bfa', '#fb7185', '#fbbf24', '#4ade80'],
            hoverOffset: 10
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            title: {
                display: true,
                text: 'Weekly Client Feedbacks ({{ month_name }})',
                font: { size: 16 }
            },
            legend: {
                position: 'bottom',
                labels: { boxWidth: 12, font: { size: 12 } }
            },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        if (feedbackData.every(v => v === 0)) {
                            return 'No data available';
                        }
                        const label = context.label || '';
                        const value = context.raw;
                        const total = context.chart._metasets[0].total;
                        const percentage = ((value / total) * 100).toFixed(1);
                        return `${label}: ${value} feedbacks (${percentage}%)`;
                    }
                }
            }
        }
    }
});

const typeData = {{ goal_type_data|safe }};
const typeCtx = document.getElementById('goalsByTypePie');
new Chart(typeCtx, {
  type: 'doughnut',
  data: {
    labels: typeData.length ? {{ goal_type_labels|safe }} : ['No Data'],
    datasets: [{
      label: 'Goals by Type',
      data: typeData.length ? typeData : [1],
      backgroundColor: typeData.length
        ? ['#60a5fa', '#34d399', '#fbbf24', '#f87171', '#a78bfa', '#4ade80']
        : ['#e5e7eb'],
      borderWidth: 2,             
      hoverOffset: 10
    }]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    cutout: '37%',                
    layout: { padding: {
      top: -10,        
      bottom: -10
    } },      
    plugins: {
      title: {
        display: true,
        text: 'Goals by Type ({{ month_name }})',
        font: { size: 16 }
      },
      legend: {
        position: 'bottom',
        labels: { boxWidth: 12, font: { size: 12 } }
      },
      tooltip: {
        callbacks: {
          label: function(context) {
            if (typeData.length === 0) return 'No data available';
            const label = context.label || '';
            const value = context.raw;
            const total = context.chart._metasets[0].total;
            const percentage = ((value / total) * 100).toFixed(1);
            return `${label}: ${value} goals (${percentage}%)`;
          }
        }
      }
    }
  }
});

const staffData = {{ staff_data|safe }};
const staffCtx = document.getElementById('staffEngagementBar');
new Chart(staffCtx, {
  type: 'bar',
  data: {
    labels: staffData.every(v => v === 0) ? ['No Data'] : {{ staff_labels|safe }},
    datasets: [{
      label: 'Staff Responses',
      data: staffData.every(v => v === 0) ? [0] : staffData,
      backgroundColor: staffData.every(v => v === 0)
        ? ['#e5e7eb']
        : ['#60a5fa', '#34d399', '#fbbf24', '#f87171'],
      borderWidth: 1
    }]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    scales: {
      y: {
        beginAtZero: true,
        ticks: {
          stepSize: 1
        },
        grid: {
          color: '#f3f4f6'
        }
      },
      x: {
        grid: {
          color: '#f9fafb'
        }
      }
    },
    plugins: {
      title: {
        display: true,
        text: 'Weekly Staff Engagement ({{ month_name }})',
        font: { size: 16 }
      },
      legend: { display: false },
      tooltip: {
        callbacks: {
          label: function(context) {
            if (staffData.every(v => v === 0)) return 'No data available';
            return `${context.label}: ${context.raw} responses`;
          }
        }
      }
    }
  }
});
</script>
<style>
  .page-actions{
    position: absolute;
    top: 100px;
    right:24px;
    display:flex;
    gap:10px;
    z-index:5;
  }
  .btn1{
    display: inline-block;
    padding:10px 22px;
    background:#ffffff;
    color:#111;
    border-radius:999px;
    text-decoration:none;
    font-weight:none;
    box-shadow:0 2px 8px rgba(0,0,0,.08);
    transition:transform .15s ease, box-shadow .15s ease;


  }
  .btn1:hover{
    transform: translateY(-1px);
    box-shadow:0 6px 18 px rgba(0,0,0,.12);
  }
  .btn2{
    display: inline-block;
    padding:10px 22px;
    background:#ffffff;
    color:#111;
    border-radius:999px;
    text-decoration:none;
    font-weight:none;
    box-shadow:0 2px 8px rgba(0,0,0,.08);
    transition:transform .15s ease, box-shadow .15s ease;

  }
  .btn2:hover{
    transform: translateY(-1px);
    box-shadow:0 6px 18 px rgba(0,0,0,.12);
  }

  
</style>

{% endblock %}