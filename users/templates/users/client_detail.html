{% extends "base.html" %}
{% block content %}

<div class="top-actions">
  <a href="{% url 'clients_list' %}" class="back-btn">‚Üê Back</a>
  <button id="downloadPdf" class="download-btn">Download PDF</button>
</div>

<div class="client-detail-container">
    <div class="client-info-section">
        <h1 class="section-heading">CLIENT INFO</h1>
        <div class="client-info">
            <p><strong>Name:</strong> {{ client.name }}</p>
            <p><strong>Date of Birth:</strong> {{ client.date_of_birth|default:"None" }}</p>
            <p class="email"><strong>Email: {{ client.user.email }}</strong></p>
        </div>
    </div>

    <div class="client-chart">
        <canvas id="goalsChart"></canvas>
        <div class="edit-btn-container">
            <a href="{% url 'edit_goals' client.id %}" class="edit-btn">Edit Goals</a>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script>
    const ctx = document.getElementById('goalsChart').getContext('2d');
    const goalsChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: [{% for g in goals %}'{{ g.goal_type.name }}'{% if not forloop.last %}, {% endif %} {% endfor %}],
            datasets: [{
                data: [{% for g in goals %}{{ g.progress }} {% if not forloop.last %}, {% endif %}{% endfor %}],
                backgroundColor: '#FFD700',
                borderRadius: 4,
                barThickness: 60,
                categoryPercentage: 0.6
            }]
        },
        options: {
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: { enabled: false },
                datalabels: {
                    color: 'black',
                    font: { weight: 'bold', size: 14 },
                    formatter: (value) => value + '%'
                }
            },
            scales: {
                x: {
                    grid: { display: false },
                    ticks: { 
                        font: { weight: 'bold', size: 12 },
                        callback: function(value, index) {
                            let label = this.getLabelForValue(value);
                            const words = label.split(" ");
                            let lines = [];
                            let currentLine = "";

                            words.forEach(word => {
                                if ((currentLine + " " + word).trim().length <= 12) {
                                    currentLine = (currentLine + " " + word).trim();
                                } else {
                                    lines.push(currentLine);
                                    currentLine = word;
                                }
                            });
                            if (currentLine) lines.push(currentLine);
                            return lines; 
                        }
                    }
                },
                y: {
                    beginAtZero: true,
                    max: 100,
                    ticks: { stepSize: 20 },
                    grid: { color: '#ddd' }
                }
            }
        },
        plugins: [ChartDataLabels]
    });
    document.getElementById("downloadPdf").addEventListener("click", function () {
        const { jsPDF } = window.jspdf;
        const element = document.querySelector(".client-detail-container");

        html2canvas(element, { scale: 2 }).then((canvas) => {
            const imgData = canvas.toDataURL("image/png");

            const pdf = new jsPDF("landscape", "mm", "a4");
            const pdfWidth = pdf.internal.pageSize.getWidth();
            const pdfHeight = pdf.internal.pageSize.getHeight();

            const imgWidth = pdfWidth - 20; // leave some margins
            const imgHeight = (canvas.height * imgWidth) / canvas.width;

            const yPos = (pdfHeight - imgHeight) / 2;

            pdf.addImage(imgData, "PNG", 10, yPos, imgWidth, imgHeight);
            const clientName = "{{ client.name|escapejs }}";
            pdf.save(clientName + "_info.pdf");
        });
    });
</script>

<style>
    .top-actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin: 5px 0 25px 0;
    }

    .download-btn {
        font-size: 14px;
        padding: 6px 14px;
        background: #28a745;
        color: #fff;
        border-radius: 4px;
        border: none;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.2s ease;
    }

    .download-btn:hover {
        background: #218838;
    }

    .client-detail-container {
        display: grid;
        grid-template-columns: 1fr 2fr;
        align-items: start;
        justify-content: center;
        gap: 80px;
        margin: 30px auto;
        max-width: 1100px;
    }

    .section-heading {
        text-align: center;
        margin-bottom: 50px;
        font-family: 'Montserrat', sans-serif;
        font-size: 24px;
        font-weight: 700;
    }

    .client-info {
        background: #f5f7ff;
        padding: 25px;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        font-family: 'Montserrat', sans-serif;
        font-size: 18px;
        font-weight: 600;
        text-transform: uppercase;
    }

    .client-info p {
        margin: 12px 0;
    }

    .client-info .email {
        text-transform: none;        
        font-weight: 600;           
        white-space: nowrap; 
        font-size: 19px;        
    }

    .client-chart {
        width: 550px;
        height: 350px;
        margin-top: 10px;
        margin-left: 60px;
    }
    
    .back-btn,
    .edit-btn {
        display: inline-block;
        font-size: 14px;           
        padding: 5px 12px;         
        background: #0056b3;       
        color: #FFFFFF;
        border-radius: 4px;
        text-decoration: none;
        font-weight: 600;
        transition: background 0.2s ease;
    }

    .back-btn:hover,
    .edit-btn:hover {
        background: #004494;       
    }

    .edit-btn-container {
        margin-top: 20px;
        text-align: center;
    }
</style>
{% endblock %}