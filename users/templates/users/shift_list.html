{% extends "base.html" %}
{% block content %}
{% if request.GET.deleted %}
  <div class="alert success shift-alert">Shift deleted successfully!</div>
  <script>
    setTimeout(() => {
      document.querySelector('.alert.success').style.display = 'none';
    }, 2000);
  </script>
{% endif %}

<div class="staff-dashboard">
    <div class="shift-table-container">
      <h1 class="section-heading">Shift Log</h1>
      <div class="btn-container">
        <a href="{% url 'allocate_shift' %}" class="btn">Create Shift</a>
        <a href="{% url 'export_shifts_pdf'%}" class="btn2"> Download Shift</a>
      </div>
      <table class="shift-table">
          <thead>
              <tr>
                  <th>Date</th>
                  <th>Staff</th>
                  <th>Clients</th>
                  <th>Start Time</th>
                  <th>End Time</th>
                  <th>Actions</th>
              </tr>
          </thead>
          <tbody>
              {% for shift in shifts %}
              <tr>
                  <td>{{ shift.date|date:"d/m/Y" }}</td>
                  <td class="staff-cell" data-fullname="{{ shift.staff.name }}">{{ shift.staff.name }}</td>
                  <td class="client-cell" data-fullnames="{% for client in shift.clients.all %}{{ client.name }}{% if not forloop.last %}, {% endif %}{% endfor %}">
                      {% for client in shift.clients.all %}
                          {{ client.name }}{% if not forloop.last %}, {% endif %}
                      {% endfor %}
                  </td>
                  <td>{{ shift.start_time }}</td>
                  <td>{{ shift.end_time }}</td>
                  <td><a href="{% url 'edit_shift' shift.id %}?from=log" aria-label="Edit Shift"class="edit-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512">
                        <path d="M402.3 344.9l32-32c5-5 13.7-1.5 13.7 5.7V464c0 
                        26.5-21.5 48-48 48H48c-26.5 0-48-21.5-48-48V112c0-26.5 
                        21.5-48 48-48h273.5c7.1 0 10.7 8.6 5.7 
                        13.7l-32 32c-1.5 1.5-3.5 2.3-5.7 
                        2.3H48v352h352V350.5c0-2.1.8-4.1 
                        2.3-5.6zm156.6-201.8L296.3 405.7l-90.4 
                        10c-26.2 2.9-48.5-19.2-45.6-45.6l10-90.4L432.9 
                        17.1c22.9-22.9 59.9-22.9 82.7 
                        0l43.2 43.2c22.9 22.9 22.9 60 
                        .1 82.8zM460.1 174L402 115.9 216.2 
                        301.8l-7.3 65.3 65.3-7.3L460.1 
                        174zm64.8-79.7l-43.2-43.2c-4.1-4.1-10.8-4.1-14.8 
                        0L436 82l58.1 58.1 30.9-30.9c4-4.2 
                        4-10.8-.1-14.9z"/>
                   </svg></a>
                </td>
              </tr>
              {% empty %}
              <tr>
                  <td colspan="5" class="no-data">No shifts allocated yet.</td>
              </tr>
              {% endfor %}
          </tbody>
      </table>
      <div class="table-footer">
        <a href="{% url 'all_shifts' %}" class="btn view-all-btn">View All</a>
      </div>
  </div>
  <div class="staff-chart-container">
      <canvas id="staffChart"></canvas>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const ctx = document.getElementById('staffChart').getContext('2d');
  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: {{ chart_labels|safe }},
      datasets: [{
        label: 'Staff Worked',
        data: {{ chart_data|safe }},
        backgroundColor: 'gold'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false }
      },
      scales: {
        x: { title: { display: true, text: 'Days' } },
        y: { title: { display: true, text: 'Staff Worked' }, beginAtZero: true, ticks: { stepSize: 1 }, max: 6 }
      }
    }
  });
</script>
<script>
document.querySelectorAll('.client-cell, .staff-cell').forEach(cell => {
  cell.addEventListener('mousemove', e => {
    cell.style.setProperty('--mouse-x', e.pageX + 10 + 'px');
    cell.style.setProperty('--mouse-y', e.pageY + 20 + 'px');
  });
});
</script>

<style>
.client-cell {
  max-width: 180px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  position: relative;
  cursor: default;   
}
.client-cell:hover::after {
  content: attr(data-fullnames); 
  position: fixed;
  left: var(--mouse-x);
  top: var(--mouse-y);
  background: #333;
  color: #fff;
  padding: 5px 8px;
  border-radius: 4px;
  white-space: normal;
  z-index: 1000;
  font-size: 13px;
  max-width: 300px;
  pointer-events: none;
}
.staff-cell {
  max-width: 160px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  position: relative;
  cursor: default;
}
.staff-cell:hover::after {
  content: attr(data-fullname);
  position: fixed;
  left: var(--mouse-x);
  top: var(--mouse-y);
  background: #333;
  color: #fff;
  padding: 5px 8px;
  border-radius: 4px;
  white-space: normal;
  z-index: 1000;
  font-size: 13px;
  max-width: 300px;
  pointer-events: none;
}
.staff-dashboard {
    display: flex;
    justify-content: space-between; 
    align-items: flex-start;  
    margin: 20px;
    gap: 20px;
    margin-right: 300px;
}

.shift-table-container {
    flex: 0 0 50%;
    background: #fff;
    padding: 12px;
    border-radius: 10px;
    box-shadow: 0 3px 8px rgba(0,0,0,0.1);
    margin-right: 5px;
    margin-top: -10px;
    position: relative;  
    padding-bottom: 70px;
}

.section-heading {
    text-align: center;
    font-size: 20px;
    font-weight: 700;
    margin-bottom: 10px;
}

.shift-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 14px;
}
.shift-table th, .shift-table td {
    padding: 8px;
    border: 1px solid #ccc;
    text-align: center;
}
.shift-table th {
    background: #f5f5f5;
}
.shift-table th:nth-child(1), 
.shift-table td:nth-child(1) {
    min-width: 100px;  
}
.shift-table th:nth-child(2),
.shift-table td:nth-child(2) {
    white-space: nowrap;
    min-width: 120px;  
    max-width: 160px;   
    text-overflow: ellipsis;
    overflow: hidden;
}
.shift-table th:nth-child(4),
.shift-table td:nth-child(4),
.shift-table th:nth-child(5),
.shift-table td:nth-child(5) {
    min-width: 80px;   
}
.no-data {
    text-align: center;
    font-style: italic;
    color: #777;
}
.btn {
    display: inline-block;
    margin-bottom: 10px;
    padding: 7px 14px;
    background: #0056b3;
    color: #fff;
    border-radius: 6px;
    font-size: 14px;
    text-decoration: none;
    transition: background 0.2s ease;
}
.btn:hover {
    background: #003f8a;
}
.edit-btn svg {
    width: 18px;
    height: 18px;
    fill: #0056b3;
    transition: fill 0.2s ease;
}
.edit-btn:hover svg {
    fill: #003f8a;
}
.staff-chart-container {
    flex: 1;
    height: 380px;
    min-width: 50%;
}
#staffChart {
    width: 100% ;
    height: 100% ;
    background: transparent;
}
.table-footer {
    display: flex;
    justify-content: center;
    position: absolute;
    bottom: 15px;   
    right: 11px;   
    margin: 0;
}
.view-all-btn {
    background: #0056b3;
    color: white;
    padding: 7px 14px;
    border-radius: 6px;
    text-decoration: none;
    font-size: 14px;
    transition: background 0.2s ease;
}
.view-all-btn:hover {
    background: #003f8a;
}
.shift-alert {
    margin-left: 40px;   
}
.btn2 {
    display: inline-block;
    margin-bottom: 10px;
    padding: 7px 14px;
    background: #0056b3;
    color: #fff;
    border-radius: 6px;
    font-size: 14px;
    text-decoration: none;
    transition: background 0.2s ease;
}
.btn2:hover {
    background: #003f8a;
}

</style>
{% endblock %}